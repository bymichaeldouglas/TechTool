<!DOCTYPE html>
<html>
<head>
  <!-- Metadata and CSS links -->
  <link rel="stylesheet" href="jq.css">
  <link rel="stylesheet" href="main.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="VS.css">
` <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

  <!-- JavaScript libraries -->
  <script src="js/vendor/modernizr.js"></script>
  <script src="js/vendor/jcropper.js"></script>
  <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<style>


</style>
<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="index.html">TECHTOOL</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">
              
              <li class="nav-item">
                <a class="nav-link" href="#">JQ</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="href="table.html">  </a>
              </li>
              
              
            </ul>
          </div>
        </div>
      </nav>

  <div class="container">
    <table id="jq-table" class="table">
        <thead class="thead-dark">
          <tr>
            <th>Tool</th>
            <th>Thing</th>
            <th>Classifier</th>
          </tr>
        </thead>
        <tbody>
          
          <tr>
            <td colspan="1" >Pass</td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      <button id="add-column-button" class="btn btn-primary">Add Visibility Statement</button>
      <button id="add-row-button" class="btn btn-primary">Add Object</button>
      <button id="generate-button" class="btn btn-success">Generate Statements</button>
      <div>
        
        <div id="top">
            
        </div>
        <div id="content">
          <div class="container-fluid mt-3">
    
            
            <div class="row">
              
                <div id="query" class="col-sm-7 bg-primary text-white">
                  <label id="filter-label" for="filter">Query</label>
                  <textarea
                    id="filter"
                    type="text"
                    name="filter"
                    autocapitalize="off"
                    autocomplete="on"
                    spellcheck="false"
                    autocorrect="off"
                    autofocus
                    class="form-control mt-8 resizable"
                    rows="14"
                  ></textarea>
              </div>
    
              
              
    
                <div id="input" class="col-sm-3 bg-dark text-white">
                  <label id="input-label" for="input-json">Input</label>
                  <textarea
                    id="input-json"
                    name="input"
                    placeholder="Paste your input json here"
                    autocapitalize="off"
                    autocomplete="off"
                    spellcheck="false"
                    autocorrect="off"
                    class="form-control mt-8 resizable"
                    rows="14"
                  ></textarea>
                </div>
    
              
              
                <div id="output" class="col-sm-2 bg-primary text-white">
                  <label id="output-label" for="output-json">Result</label>
                  <textarea
                    id="output-json"
                    placeholder="Output will appear here"
                    class="form-control mt-8 resizable"
                    rows="14"
                    readonly
                  ></textarea>
              </div>
              
            </div>
            <br>
          
            
          </div>
            
                
            </div>
    
            
    
            
        </div>
    
  </div>
  <!-- Modal -->

  
  <!-- Service Worker and Dynamic Content Scripts -->
  <script>
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/jq_offline/service_worker.js', { scope: '/jq_offline' })
        .then(function(registration) {
              console.log('Service Worker Registered');
        })
        .catch(e => {
          console.log('Unable to register service worker', e);
        });

      navigator.serviceWorker.ready.then(function(registration) {
         console.log('Service Worker Ready');
      })
      .catch(e => {
        console.log('Service worker unable to get ready', e);
      });
    }
  </script>
  
  <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
  <script defer type="module">
    async function setup() {
let params = (new URL(document.location)).searchParams;

// Only set the form elements if the URL parameters are present
if (params.has('query')) {
  document.getElementById("filter").value = params.get('query');
}


}

    async function jq() {
      let data = document.getElementById("input-json").value;
      let query = document.getElementById("filter").value;

      let params = (new URL(document.location)).searchParams;
      let options = ["--monochrome-output"];
      

      // Update url query params with current query
      params.set('query', query);
      const url = new URL(document.location);
      url.search = params.toString();
      window.history.replaceState({}, 'Jq Offline', url);

      // Create mock JSON file
      await CLI.fs.writeFile("test.json", data);

      options.push(query);
      options.push("test.json");

      let output = await CLI.exec("jq", options);
      document.getElementById("output-json").value = output;
    }

    // buffer and call the callback only after no activity for "interval": aka debounce
    // This reduces load on the browser by avoiding jq evaluation while the user is typing
    function debounce(callback, interval) {
      let debounceTimeoutId;

      return function(...args) {
        clearTimeout(debounceTimeoutId);
        debounceTimeoutId = setTimeout(() => callback.apply(this, args), interval);
      };
    }

    let delayedJq = debounce(jq,  400);

    setup();
    let CLI = await new Aioli("jq/1.7");
      
    document.getElementById("filter").addEventListener('input', delayedJq);
    
    document.getElementById("input-json").addEventListener('input', delayedJq);
    
    document.getElementById("generate-button").addEventListener('input', Jq);
    // Call jq the first time without any changes
    jq();
  </script>

  <!-- Table Manipulation and JQ Execution Scripts -->
  <script>
    // Add event listeners for buttons
    document.getElementById("add-column-button").addEventListener("click", addColumn);
    document.getElementById("add-row-button").addEventListener("click", addRow);
    document.getElementById("generate-button").addEventListener("click", generateStatements);

    function addColumn() {
      var table = document.getElementById("jq-table");
      var columnCount = table.rows[0].cells.length;
      table.rows[0].insertCell(columnCount - 0);
      table.rows[0].cells[columnCount - 0].innerHTML = `VS`;
      for (var i = 1; i < table.rows.length; i++) {
        table.rows[i].insertCell(columnCount);
        table.rows[i].cells[columnCount].innerHTML = `<input type="checkbox" />`;
      }
    }

    // Function to add a new row
    function addRow() {
    var table = document.getElementById("jq-table");
    var rowCount = table.rows.length;
    var newRow = table.insertRow(rowCount - 1);

    // Tool input
    var cellTool = newRow.insertCell(0);
    cellTool.innerHTML = `<input type="text" value="Detector 1" class="form-control"/>`;

    // Thing input
    var cellThing = newRow.insertCell(1);
    cellThing.innerHTML = `<input type="text" value="Part" class="form-control"/>`;

    // Attributes input with icon for modal
    var cellAttributes = newRow.insertCell(2);
    cellAttributes.innerHTML = `
    <div class="d-flex align-items-center">
        <input type="checkbox" class="form-control form-control-sm me-1 form-check-input" title="CLASSIFIER" />
        ${[
            { label: "X", value: 0 },
            { label: "Y", value: 0 },
            { label: "X+W", value: 0 },
            { label: "Y+H", value: 0 },
            { label: "Max-W", value: 0 },
            { label: "Min-W", value: 0 },
            { label: "Max-H", value: 0 },
            { label: "Min-H", value: 0 }
        ].map(attr => `<input type="number" class="form-control form-control-sm me-1 d-none" title="${attr.label}" value="${attr.value}" style="width: 50px;">`).join('')}
        <i class="fas fa-edit" data-bs-toggle="modal" data-bs-target="#editModal" onclick="populateModal(this)"></i>
    </div>`;

    // Append checkboxes for remaining columns
    for (var j = 3; j < table.rows[0].cells.length; j++) {
        var cellCheckbox = newRow.insertCell(j);
        cellCheckbox.innerHTML = `<input type="checkbox" class="form-check-input" />`;
    }
}


var currentEditingInput;

function populateModal(icon) {
    currentEditingInput = icon.closest('.d-flex').querySelectorAll('input[type="number"]');
    var formGroup = document.getElementById('edit-form').querySelector('.form-group');
    let htmlContent = ''; // Initialize an empty string to build HTML content
    formGroup.innerHTML = ''; // Clear dynamic input fields
    // Loop through inputs and create rows with two columns each
    currentEditingInput.forEach((input, index) => {
        var title = input.getAttribute('title');
        
        // Add a row div for every two inputs or start of the loop
        if (index % 2 === 0) {
            if (index > 0) {
                htmlContent += '</div>'; // Close the previous row if it's not the first element
            }
            htmlContent += '<div class="row">'; // Start a new row
        }

        // Add a column div for each input
        htmlContent += `
            <div class="col-md-6">
                <div class="mb-2">
                    <label class="form-label">${title}</label>
                    <input type="number" class="form-control" value="${input.value}" title="Attribute ${index + 1}" data-index="${index}">
                </div>
            </div>`;

        // If it's the last input and an odd index, close the row div
        if (index === currentEditingInput.length - 1) {
            htmlContent += '</div>'; // Ensure the last row is closed if it contains an odd number of inputs
        }
    });

    // Ensure all HTML is properly closed
    if (currentEditingInput.length % 2 !== 0) {
        htmlContent += '</div>'; // Close the row div if the total number of inputs is odd
    }

    formGroup.innerHTML = htmlContent; // Update the innerHTML with the complete HTML content
}



function saveChanges() {
    var modalInputs = document.querySelectorAll('#edit-form input[type="number"]');
    modalInputs.forEach((modalInput, index) => {
        // Update the original inputs in the table with the new values from the modal
        currentEditingInput[index].value = modalInput.value;
    });
    $('#editModal').modal('hide');
}



function constructFilterStatement(toolValue, thingValue, conditions) {
    let filterStatement = `([."${toolValue}".output[] | select(.class== "${thingValue}"`;

    conditions.forEach(condition => {
        if (condition.value !== "" && condition.value !== "0") {
            filterStatement += ` ${condition.operator} ${condition.expression.replace("{}", condition.value)}`;
        }
    });

    filterStatement += ")] | any)";
    return filterStatement;
}

function generateStatementsog() {
    var table = document.getElementById("jq-table");
    var rows = table.rows;
    var columns = table.rows[0].cells.length - 3;  // Assuming the first three columns are fixed

    var visibleStatements = [];
    var passStatements = [];

    // Iterate over checkbox columns starting from the 4th column (index 3)
    for (var j = 3; j < columns + 3; j++) {
        for (var i = 1; i < rows.length - 1; i++) { // Excluding the header and any summary or pass rows
            var row = rows[i];
            var toolValue = row.cells[0].querySelector('input[type="text"]').value;
            var thingValue = row.cells[1].querySelector('input[type="text"]').value;
            var classifierChecked = row.cells[2].querySelector('input[type="checkbox"]').checked;
            var conditions = buildConditions(row);

            let filterStatement = constructFilterStatement(toolValue, thingValue, conditions);
            var checkbox = row.cells[j].querySelector('input[type="checkbox"]');

            if (checkbox.checked) {
                visibleStatements.push(filterStatement); // Always add to visible unless specified otherwise

                if (classifierChecked) {
                    // Construct specific pass condition statement if classifier checkbox is checked
                    let passConditionStatement = `(([."${toolValue}".output[] | select(.class== "${thingValue}")] | any)`;
                    passStatements.push(`(${passConditionStatement} and ${filterStatement})`);
                }
            }
        }
    }

    var output = "{\n";
    output += `"visible": (${visibleStatements.join(" or ")}),\n`;
    output += `"pass": (${passStatements.join(" or ")})\n`;
    output += "}";

    var statementTextArea = document.getElementById("filter");
    statementTextArea.value = output;

    jq();
    delayedJq();
}

function buildConditions(row) {
    return [
        { value: row.cells[2].querySelectorAll('input[type="number"]')[0].value, operator: "and", expression: "(.x >= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[1].value, operator: "and", expression: "(.y >= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[2].value, operator: "and", expression: "((.x + .w) <= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[3].value, operator: "and", expression: "((.y + .h) <= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[4].value, operator: "and", expression: "(.w >= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[5].value, operator: "and", expression: "(.w <= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[6].value, operator: "and", expression: "(.h >= {})" },
        { value: row.cells[2].querySelectorAll('input[type="number"]')[7].value, operator: "and", expression: "(.h <= {})" }
    ];
}

function generateVisibleStatements(rows, columns) {
    let statements = [];
    for (let j = 3; j < columns + 3; j++) {
        let columnStatements = [];
        for (let i = 1; i < rows.length - 1; i++) {
            let row = rows[i];
            let toolValue = row.cells[0].querySelector('input[type="text"]').value;
            let thingValue = row.cells[1].querySelector('input[type="text"]').value;
            let classifierChecked = row.cells[2].querySelector('input[type="checkbox"]').checked;

            if (row.cells[j].querySelector('input[type="checkbox"]').checked) {
                
                let statement = constructFilterStatement(row);
                columnStatements.push(statement);

                
            }
        }

        if (columnStatements.length > 0) {
            statements.push("(" + columnStatements.join(" and ") + ")");
        }
    }
    return statements;
}

function generatePassStatements(rows, columns) {
    let passStatements = [];
    let passRow = rows[rows.length - 1]; // Assuming last row is for "pass" conditions
    for (let j = 3; j < columns + 3; j++) {
        let passColumnStatement = [];
        if (passRow.cells[j].querySelector('input[type="checkbox"]').checked) {
            for (let i = 1; i < rows.length - 1; i++) {
                let row = rows[i];
                if (row.cells[j].querySelector('input[type="checkbox"]').checked) {
                    let statement = constructPassFilterStatement(row);
                    passColumnStatement.push(statement);
                }
            }
        }
        if (passColumnStatement.length > 0) {
            passStatements.push("(" + passColumnStatement.join(" and ") + ")");
        }
    }
    return passStatements;
}
function combineAndDisplayResults(visibleStatements, passStatements) {
    let output = "{\n";
    output += `"visible": (${visibleStatements.join(" or ")}),\n`;
    output += `"pass": (${passStatements.join(" or ")})\n`;
    output += "}";
    
    let statementTextArea = document.getElementById("filter");
    statementTextArea.value = output;
    jq();
    delayedJq();
}
function constructFilterStatement(row) {
    let toolValue = row.cells[0].querySelector('input[type="text"]').value;
    let thingValue = row.cells[1].querySelector('input[type="text"]').value;
    let classifierChecked = row.cells[2].querySelector('input[type="checkbox"]').checked;
    // Assuming attributes start from cell index 2 onwards
    let filterStatement = `([."${toolValue}".output[] | select(.class== "${thingValue}"`;
    row.cells[2].querySelectorAll('input[type="number"]').forEach((input, index) => {
        let value = input.value;
        if (value !== "" && value !== "0") {
            switch (index) {
                case 0: filterStatement += ` and (.x >= ${value})`; break;
                case 1: filterStatement += ` and (.y >= ${value})`; break;
                case 2: filterStatement += ` and ((.x + .w) <= ${value})`; break;
                case 3: filterStatement += ` and ((.y + .h) <= ${value})`; break;
                case 4: filterStatement += ` and (.w <= ${value})`; break;
                case 5: filterStatement += ` and (.w >= ${value})`; break;
                case 6: filterStatement += ` and (.h <= ${value})`; break;
                case 7: filterStatement += ` and (.h >= ${value})`; break;
            }
        }
        
        
    });
    if (classifierChecked) {
        filterStatement += ')] | any) and ([."Classifier 1".output[] | select(.classification != "not_visible")]| any)';
    } else {
    filterStatement += ")] | any)";}
    return filterStatement;
}
function constructPassFilterStatement(row) {
    let toolValue = row.cells[0].querySelector('input[type="text"]').value;
    let thingValue = row.cells[1].querySelector('input[type="text"]').value;
    let classifierChecked = row.cells[2].querySelector('input[type="checkbox"]').checked;
    // Assuming attributes start from cell index 2 onwards
    let filterStatement = `([."${toolValue}".output[] | select(.class== "${thingValue}"`;
    row.cells[2].querySelectorAll('input[type="number"]').forEach((input, index) => {
        let value = input.value;
        if (value !== "" && value !== "0") {
            switch (index) {
                case 0: filterStatement += ` and (.x >= ${value})`; break;
                case 1: filterStatement += ` and (.y >= ${value})`; break;
                case 2: filterStatement += ` and ((.x + .w) <= ${value})`; break;
                case 3: filterStatement += ` and ((.y + .h) <= ${value})`; break;
                case 4: filterStatement += ` and (.w <= ${value})`; break;
                case 5: filterStatement += ` and (.w >= ${value})`; break;
                case 6: filterStatement += ` and (.h <= ${value})`; break;
                case 7: filterStatement += ` and (.h >= ${value})`; break;
            }
        }
        
        
    });
    if (classifierChecked) {
        filterStatement += ')] | any) and ([."Classifier 1".output[] | select(.classification == "passed")]| any)';
    } else {
    filterStatement += ")] | any)";}
    return filterStatement;
}
function generateStatements() {
    var table = document.getElementById("jq-table");
    var rows = table.rows;
    var columns = table.rows[0].cells.length - 3;

    let visibleStatements = generateVisibleStatements(rows, columns);
    let passStatements = generatePassStatements(rows, columns);
    combineAndDisplayResults(visibleStatements, passStatements);
}




async function jq() {
    let data = document.getElementById("input-json").value;
    let query = document.getElementById("filter").value;
    let params = (new URL(document.location)).searchParams;
    let options = ["--monochrome-output"];
    params.set('query', query);
    const url = new URL(document.location);
    url.search = params.toString();
    window.history.replaceState({}, '', url);

    // Create mock JSON file
    await CLI.fs.writeFile("test.json", data);
    options.push(query);
    options.push("test.json");

    let output = await CLI.exec("jq", options);
    document.getElementById("output-json").value = output;
}

document.getElementById("filter").addEventListener('input', jq);


  </script>
<script>
  window.addEventListener('DOMContentLoaded', (event) => {
      fetch('jqmodal2.html')
          .then(response => response.text())
          .then(html => {
              document.body.insertAdjacentHTML('beforeend', html);
              bindCropper(); //  initialize all related scripts
          })
          .catch(error => {
              console.error('Error loading the modal:', error);
          });
  });
  
  function bindCropper() {
      var imageInput = document.getElementById('imageInput');
      if (imageInput) {
          imageInput.addEventListener('change', function (event) {
              var files = event.target.files;
              if (files && files.length > 0) {
                  var reader = new FileReader();
                  reader.onload = function (e) {
                      var image = document.getElementById('image');
                      if (window.cropper) {
                          window.cropper.destroy(); // Destroy any previous instance
                      }
                      image.src = e.target.result;
                      window.cropper = new Cropper(image, {
                        viewMode: 2, // Ensure the image can't be smaller than the container
                        dragMode: 'none', // Disable dragging of the image
                        zoomable: false, // Disable zooming
                        scalable: false, // Disable scaling
                        toggleDragModeOnDblclick: false, // Disable toggling drag mode on double click
                        aspectRatio: NaN,
                          crop(event) {
                              document.querySelector('[title="Attribute 1"]').value = Math.round(event.detail.x);
                              document.querySelector('[title="Attribute 2"]').value = Math.round(event.detail.y);
                              document.querySelector('[title="Attribute 3"]').value = Math.round(event.detail.x + event.detail.width);
                              document.querySelector('[title="Attribute 4"]').value = Math.round(event.detail.y + event.detail.height);
                          }
                      });
                  };
                  reader.readAsDataURL(files[0]);
              }
          });
      }
  }
    </script>
</body>
</html>

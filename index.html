<!DOCTYPE html>
<html>
<head>
  <title>JQ TT</title>
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="jq.html">JQ</a></li>
    </ul>
  </nav>
  <script src="js/vendor/modernizr.js"></script>
  <link rel="stylesheet" href="jq.css">
  
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script>
      if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/jq_offline/service_worker.js', { scope: '/jq_offline' })
          .then(function(registration) {
                console.log('Service Worker Registered');
          })
          .catch(e => {
            console.log('Unable to register service worker', e);
          });

        navigator.serviceWorker.ready.then(function(registration) {
           console.log('Service Worker Ready');
        })
        .catch(e => {
          console.log('Service worker unable to get ready', e);
        });
      }
    </script>
    
    <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
    <script defer type="module">
      async function setup() {
  let params = (new URL(document.location)).searchParams;

  // Only set the form elements if the URL parameters are present
  if (params.has('query')) {
    document.getElementById("filter").value = params.get('query');
  }

  
}

      async function jq() {
        let data = document.getElementById("input-json").value;
        let query = document.getElementById("filter").value;

        let params = (new URL(document.location)).searchParams;
        let options = ["--monochrome-output"];
        

        // Update url query params with current query
        params.set('query', query);
        const url = new URL(document.location);
        url.search = params.toString();
        window.history.replaceState({}, 'Jq Offline', url);

        // Create mock JSON file
        await CLI.fs.writeFile("test.json", data);

        options.push(query);
        options.push("test.json");

        let output = await CLI.exec("jq", options);
        document.getElementById("output-json").value = output;
      }

      // buffer and call the callback only after no activity for "interval": aka debounce
      // This reduces load on the browser by avoiding jq evaluation while the user is typing
      function debounce(callback, interval) {
        let debounceTimeoutId;

        return function(...args) {
          clearTimeout(debounceTimeoutId);
          debounceTimeoutId = setTimeout(() => callback.apply(this, args), interval);
        };
      }

      let delayedJq = debounce(jq,  400);

      setup();
      let CLI = await new Aioli("jq/1.7");
		
      document.getElementById("filter").addEventListener('input', delayedJq);
      
      document.getElementById("input-json").addEventListener('input', delayedJq);
      
      document.getElementById("generate-button").addEventListener('input', Jq);
      // Call jq the first time without any changes
      jq();
    </script>
</head>

</head>
<body>
  <div class="container">
    <h1 class="mt-4">JQ TT</h1>
    <table id="jq-table" class="table">
      <thead class="thead-dark">
        <tr>
          <th>Tool</th>
          <th>Thing</th>
          <th>VS</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" class="form-control" value="Detector 1" /></td>
          <td><input type="text" class="form-control" value="Part" /></td>
          <td><input type="checkbox" class="form-check-input" /></td>
        </tr>
        <tr>
          <td><input type="text" class="form-control" value="Detector 1" /></td>
          <td><input type="text" class="form-control" value="Part" /></td>
          <td><input type="checkbox" class="form-check-input" /></td>
        </tr>
        <tr>
          <td colspan="1">Pass</td>
          <td></td>
          <td><input type="checkbox" class="form-check-input" /></td>
        </tr>
      </tbody>
    </table>
    <button id="add-column-button" class="btn btn-primary">+ Add Visibility Statemetn</button>
    <button id="add-row-button" class="btn btn-primary">Add Object</button>
    <button id="generate-button" class="btn btn-success">Generate Statements</button>
    
  

  <script>
    // Add event listeners for buttons
    document.getElementById("add-column-button").addEventListener("click", addColumn);
    document.getElementById("add-row-button").addEventListener("click", addRow);
    document.getElementById("generate-button").addEventListener("click", generateStatements);

    function addColumn() {
      var table = document.getElementById("jq-table");
      var columnCount = table.rows[0].cells.length;
      table.rows[0].insertCell(columnCount - 1);
      table.rows[0].cells[columnCount - 1].innerHTML = `VS`;
      for (var i = 1; i < table.rows.length; i++) {
        table.rows[i].insertCell(columnCount);
        table.rows[i].cells[columnCount].innerHTML = `<input type="checkbox" />`;
      }
    }

    // Function to add a new row
    function addRow() {
      var table = document.getElementById("jq-table");
      var rowCount = table.rows.length;
      table.insertRow(rowCount - 1);
      table.rows[rowCount - 1].insertCell(0);
      table.rows[rowCount - 1].cells[0].innerHTML = `<input type="text" value="Detector 1" />`;
      table.rows[rowCount - 1].insertCell(1);
      table.rows[rowCount - 1].cells[1].innerHTML = `<input type="text" value="Part" />`;
      for (var j = 2; j < table.rows[0].cells.length; j++) {
        table.rows[rowCount - 1].insertCell(j);
        table.rows[rowCount - 1].cells[j].innerHTML = `<input type="checkbox" />`;
      }
    }

    // Function to generate statements
function generateStatements() {
  var table = document.getElementById("jq-table");
  var rows = table.rows;
  var statements = [];

  // Iterate over rows (excluding the header row)
  for (var i = 1; i < rows.length - 1; i++) {
    var row = rows[i];
    var toolValue = row.cells[0].querySelector('input[type="text"]').value;
    var thingValue = row.cells[1].querySelector('input[type="text"]').value;
    var checkboxStates = [];

    // Iterate over checkboxes in the row
    for (var j = 2; j < row.cells.length; j++) {
      var checkbox = row.cells[j].querySelector('input[type="checkbox"]');
      if (checkbox.checked) {
        checkboxStates.push(`([."${toolValue}".output[] | select(.class== "${thingValue}" and (.y >= 0))] | any)`);
      }
    }

    // Construct the statement for this row
    if (checkboxStates.length > 0) {
      statements.push("(" + checkboxStates.join(" and ") + ")");
    }
  }

  // Iterate over the last row (Pass row)
  var passRow = rows[rows.length - 1];
  var passStatements = [];

  for (var j = 2; j < passRow.cells.length; j++) {
    var checkbox = passRow.cells[j].querySelector('input[type="checkbox"]');
    if (checkbox.checked) {
      var columnStatements = [];
      for (var k = 1; k < rows.length - 1; k++) {
        var row = rows[k];
        var toolValue = row.cells[0].querySelector('input[type="text"]').value;
        var thingValue = row.cells[1].querySelector('input[type="text"]').value;
        var checkbox = row.cells[j].querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          columnStatements.push(`(([."${toolValue}".output[] | select(.class== "${thingValue}" and (.y >= 0))] | any))`);
        }
      }
      passStatements.push("(" + columnStatements.join(" or ") + ")");
    }
  }

  // Construct the final output
  var output = "{\n";
  output += `"visible": (${statements.join(" and ")}),\n`;
  output += `"pass": ${passStatements.join(" or ")}\n`;
  output += "}";

 


  var statementTextArea = document.getElementById("filter");
  statementTextArea.value = output;
  //trigger the jq function to update the output
    jq();
    delayedJq();
  async function jq() {
        let data = document.getElementById("input-json").value;
        let query = document.getElementById("filter").value;

        let params = (new URL(document.location)).searchParams;
        let options = ["--monochrome-output"];
        

        // Update url query params with current query
        params.set('query', query);
        const url = new URL(document.location);
        url.search = params.toString();
        window.history.replaceState({}, 'Jq Offline', url);

        // Create mock JSON file
        await CLI.fs.writeFile("test.json", data);

        options.push(query);
        options.push("test.json");

        let output = await CLI.exec("jq", options);
        document.getElementById("output-json").value = output;
      }
  document.getElementById("filter").addEventListener('input', jq);
}

  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <div>
  <div id="top">
        
    </div>
    <div id="content">
        <div id="query">
            <label id="filter-label" for="filter">Query</label>
            <textarea
              id="filter"
              type="text"
              name="filter"
              autocapitalize="off"
              autocomplete="on"
              spellcheck="false"
              autocorrect="off"
              autofocus
              class="form-control mt-8 resizable"
              rows="4"
            ></textarea>
        </div>
            <div style="visibility: hidden;">
              <button id="generate-button" class="btn btn-success">Generate Statements</button>
            
        </div>
        </div>

        <div id="input">
            <label id="input-label" for="input-json">Input</label>
            <textarea
              id="input-json"
              name="input"
              placeholder="Paste your input json here"
              autocapitalize="off"
              autocomplete="off"
              spellcheck="false"
              autocorrect="off"
              class="form-control mt-8 resizable"
              rows="4"
            ></textarea>
        </div>

        <div id="output">
            <label id="output-label" for="output-json">Result</label>
            <textarea
              id="output-json"
              placeholder="Output will appear here"
              class="form-control mt-8 resizable"
              rows="4"
              readonly
            ></textarea>
        </div>
    </div>
</div>
</body>
</html>

